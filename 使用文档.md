# Bilibili API Flutter Package ä½¿ç”¨æ–‡æ¡£

[![Pub Version](https://img.shields.io/pub/v/bilibili_api)](https://pub.dev/packages/bilibili_api)
[![License](https://img.shields.io/badge/BSD-3-Clause.svg)](LICENSE)

è¿™æ˜¯ä¸€ä¸ªç”¨äº Flutter/Dart çš„ Bilibili Web API å°è£…åŒ…ï¼Œæä¾›å®Œæ•´çš„ Bç«™ API è°ƒç”¨åŠŸèƒ½ã€‚

## ğŸ“‹ ç›®å½•

- [å®‰è£…](#å®‰è£…)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
- [æ¨¡å—è¯¦è§£](#æ¨¡å—è¯¦è§£)
  - [1. ç™»å½•æ¨¡å—](#1-ç™»å½•æ¨¡å—)
  - [2. ç”¨æˆ·æ¨¡å—](#2-ç”¨æˆ·æ¨¡å—)
  - [3. è§†é¢‘æ¨¡å—](#3-è§†é¢‘æ¨¡å—)
  - [4. æœç´¢æ¨¡å—](#4-æœç´¢æ¨¡å—)
  - [5. åŠ¨æ€æ¨¡å—](#5-åŠ¨æ€æ¨¡å—)
- [é«˜çº§ç”¨æ³•](#é«˜çº§ç”¨æ³•)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## å®‰è£…

åœ¨ `pubspec.yaml` ä¸­æ·»åŠ ä¾èµ–ï¼š

```yaml
dependencies:
  bilibili_api: ^0.0.1
```

ç„¶åè¿è¡Œï¼š

```bash
flutter pub get
```

---

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ä½¿ç”¨æµç¨‹

```dart
import 'package:bilibili_api/bilibili_api.dart';

void main() async {
  // 1. åˆ›å»º Cookie ç®¡ç†å™¨
  final cookieManager = CookieManager();
  
  // 2. åˆ›å»º HTTP å®¢æˆ·ç«¯
  final client = BiliHttpClient(cookieManager);
  
  // 3. åˆ›å»ºå„ä¸ª API å®ä¾‹
  final loginApi = LoginApi(client);
  final userApi = UserApi(client);
  final videoApi = VideoApi(client);
  
  // 4. ä½¿ç”¨ API
  // ... ä½ çš„ä»£ç 
}
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Cookie ç®¡ç†å™¨ (CookieManager)

è´Ÿè´£ç®¡ç† Bç«™ çš„è®¤è¯ Cookieï¼ŒåŒ…æ‹¬ `SESSDATA`ã€`bili_jct`ã€`buvid3` ç­‰ã€‚

```dart
final cookieManager = CookieManager();

// è®¾ç½® Cookie
cookieManager.setCookie('SESSDATA', 'your_sessdata_value');
cookieManager.setCookie('bili_jct', 'your_csrf_token');

// è·å– Cookie
String? sessdata = cookieManager.getCookie('SESSDATA');

// è·å–æ‰€æœ‰ Cookie
Map<String, String> allCookies = cookieManager.getAllCookies();
```

### 2. HTTP å®¢æˆ·ç«¯ (BiliHttpClient)

å°è£…äº†æ‰€æœ‰ HTTP è¯·æ±‚ï¼Œè‡ªåŠ¨å¤„ç† Cookie å’Œ WBI ç­¾åã€‚

```dart
final client = BiliHttpClient(cookieManager);

// å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨ï¼š
// - æ·»åŠ å¿…è¦çš„ Cookie
// - å¯¹éœ€è¦çš„è¯·æ±‚è¿›è¡Œ WBI ç­¾å
// - å¤„ç†é”™è¯¯å“åº”
```

### 3. WBI ç­¾å

Bç«™çš„åçˆ¬è™«æœºåˆ¶ï¼ŒæŸäº› API éœ€è¦ WBI ç­¾åã€‚æœ¬åŒ…è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

---

## æ¨¡å—è¯¦è§£

## 1. ç™»å½•æ¨¡å—

### 1.1 äºŒç»´ç ç™»å½•

Bç«™ Web ç«¯æ ‡å‡†ç™»å½•æ–¹å¼ï¼Œæœ€å®‰å…¨å¯é ã€‚

#### å®Œæ•´ç™»å½•æµç¨‹

```dart
import 'package:bilibili_api/bilibili_api.dart';

Future<void> qrLogin() async {
  final cookieManager = CookieManager();
  final client = BiliHttpClient(cookieManager);
  final loginApi = LoginApi(client);
  
  // æ­¥éª¤ 1: ç”ŸæˆäºŒç»´ç 
  final qrCode = await loginApi.generateQRCode();
  print('è¯·æ‰«æäºŒç»´ç : ${qrCode.url}');
  
  // æ­¥éª¤ 2: è½®è¯¢ç™»å½•çŠ¶æ€
  while (true) {
    await Future.delayed(Duration(seconds: 2));
    
    final status = await loginApi.pollQRCodeStatus(qrCode.qrcodeKey);
    
    switch (status.code) {
      case QRCodeStatus.scanned:
        print('äºŒç»´ç å·²æ‰«æï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤');
        break;
        
      case QRCodeStatus.success:
        print('ç™»å½•æˆåŠŸï¼');
        // Cookie å·²è‡ªåŠ¨ä¿å­˜åˆ° cookieManager
        return;
        
      case QRCodeStatus.expired:
        print('äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–');
        return;
        
      case QRCodeStatus.notScanned:
        // ç»§ç»­ç­‰å¾…
        break;
    }
  }
}
```

#### ä¾¿æ·æ–¹æ³•ï¼šè‡ªåŠ¨è½®è¯¢

```dart
// ä½¿ç”¨ pollUntilSuccess è‡ªåŠ¨è½®è¯¢
final loginApi = LoginApi(client);

final qrCode = await loginApi.generateQRCode();
print('è¯·æ‰«æ: ${qrCode.url}');

final result = await loginApi.pollUntilSuccess(
  qrCode.qrcodeKey,
  onScanned: () => print('å·²æ‰«æï¼Œè¯·ç¡®è®¤'),
);

if (result != null) {
  print('ç™»å½•æˆåŠŸï¼');
} else {
  print('ç™»å½•å¤±è´¥æˆ–è¶…æ—¶');
}
```

### 1.2 ç™»å½•ä¿¡æ¯æŸ¥è¯¢

è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚

```dart
final loginInfoApi = LoginInfoApi(client);

// è·å–å¯¼èˆªæ ç”¨æˆ·ä¿¡æ¯
final navInfo = await loginInfoApi.getNavInfo();

print('ç”¨æˆ·å: ${navInfo.uname}');
print('UID: ${navInfo.mid}');
print('ç­‰çº§: ${navInfo.level}');
print('ç¡¬å¸: ${navInfo.money}');
print('æ˜¯å¦VIP: ${navInfo.vipStatus == 1}');

// è·å– WBI ç­¾åå¯†é’¥ï¼ˆç”¨äºå…¶ä»– APIï¼‰
print('IMG Key: ${navInfo.wbiImg?.imgKey}');
print('SUB Key: ${navInfo.wbiImg?.subKey}');
```

### 1.3 è·å– WBI å¯†é’¥

æŸäº› API éœ€è¦ WBI ç­¾åï¼Œéœ€è¦å…ˆè·å–å¯†é’¥ã€‚

```dart
final loginInfoApi = LoginInfoApi(client);

// åˆ·æ–° WBI å¯†é’¥
await loginInfoApi.refreshWbiKeys();

// å¯†é’¥å·²è‡ªåŠ¨ä¿å­˜ï¼Œåç»­ API è°ƒç”¨ä¼šè‡ªåŠ¨ä½¿ç”¨
```

---

## 2. ç”¨æˆ·æ¨¡å—

### 2.1 è·å–ç”¨æˆ·ä¿¡æ¯

#### è·å–è¯¦ç»†ç”¨æˆ·ä¿¡æ¯ï¼ˆéœ€è¦ WBI ç­¾åï¼‰

```dart
final userApi = UserApi(client);

// éœ€è¦å…ˆåˆ·æ–° WBI å¯†é’¥
final loginInfoApi = LoginInfoApi(client);
await loginInfoApi.refreshWbiKeys();

// è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
final userInfo = await userApi.getUserInfo(293793435);

print('ç”¨æˆ·å: ${userInfo.name}');
print('æ€§åˆ«: ${userInfo.sex}');
print('ç­¾å: ${userInfo.sign}');
print('ç­‰çº§: ${userInfo.level}');
print('ç²‰ä¸æ•°: ${userInfo.follower}');
print('å…³æ³¨æ•°: ${userInfo.following}');

// VIP ä¿¡æ¯
if (userInfo.vip.isVip) {
  print('VIP ç±»å‹: ${userInfo.vip.isAnnualVip ? "å¹´åº¦å¤§ä¼šå‘˜" : "æœˆåº¦å¤§ä¼šå‘˜"}');
  print('VIP åˆ°æœŸæ—¶é—´: ${userInfo.vip.vipDueDate}');
}

// è®¤è¯ä¿¡æ¯
if (userInfo.official.isVerified) {
  print('è®¤è¯ç±»å‹: ${userInfo.official.title}');
  print('è®¤è¯è¯´æ˜: ${userInfo.official.desc}');
}
```

#### è·å–ç”¨æˆ·å¡ç‰‡ä¿¡æ¯ï¼ˆæ— éœ€ç­¾åï¼‰

```dart
final userApi = UserApi(client);

final cardInfo = await userApi.getUserCard(293793435);

print('ç”¨æˆ·å: ${cardInfo.name}');
print('ç²‰ä¸æ•°: ${cardInfo.follower}');
```

### 2.2 ç”¨æˆ·å…³ç³»

#### è·å–ç²‰ä¸åˆ—è¡¨

```dart
final relationApi = UserRelationApi(client);

// è·å–æŸç”¨æˆ·çš„ç²‰ä¸ï¼ˆéœ€è¦ç™»å½•æŸ¥çœ‹è‡ªå·±çš„å®Œæ•´åˆ—è¡¨ï¼‰
final followers = await relationApi.getFollowers(
  12345,  // ç”¨æˆ· mid
  ps: 50, // æ¯é¡µæ•°é‡
);

print('æ€»ç²‰ä¸æ•°: ${followers.total}');
for (var user in followers.list) {
  print('- ${user.uname} (${user.mid})');
  print('  æ˜¯å¦äº’å…³: ${user.isMutual}');
  print('  ç‰¹åˆ«å…³æ³¨: ${user.isSpecial}');
}

// è·å–ä¸‹ä¸€é¡µï¼ˆä½¿ç”¨ä¸Šæ¬¡è¿”å›çš„ offsetï¼‰
if (followers.offset != null) {
  final nextPage = await relationApi.getFollowers(
    12345,
    offset: followers.offset,
  );
}
```

#### è·å–å…³æ³¨åˆ—è¡¨

```dart
final relationApi = UserRelationApi(client);

final followings = await relationApi.getFollowings(
  12345,
  ps: 50,
  orderType: 'attention', // æŒ‰æœ€å¸¸è®¿é—®æ’åº
);

print('æ€»å…³æ³¨æ•°: ${followings.total}');
for (var user in followings.list) {
  print('- ${user.uname}');
}
```

#### è‡ªåŠ¨åˆ†é¡µè·å–å…¨éƒ¨

```dart
// è‡ªåŠ¨è·å–æ‰€æœ‰ç²‰ä¸ï¼ˆæœ€å¤š20é¡µï¼‰
final allFollowers = await relationApi.getAllFollowers(
  12345,
  maxPages: 20,
);

print('å…± ${allFollowers.length} ä¸ªç²‰ä¸');

// è‡ªåŠ¨è·å–æ‰€æœ‰å…³æ³¨
final allFollowings = await relationApi.getAllFollowings(12345);
```

### 2.3 ç”¨æˆ·ç©ºé—´ - æŠ•ç¨¿è§†é¢‘

#### è·å–ç”¨æˆ·æŠ•ç¨¿è§†é¢‘åˆ—è¡¨

```dart
final spaceApi = UserSpaceApi(client);

// éœ€è¦å…ˆåˆ·æ–° WBI å¯†é’¥
await loginInfoApi.refreshWbiKeys();

// è·å–ç”¨æˆ·æŠ•ç¨¿è§†é¢‘
final videos = await spaceApi.getUserVideos(
  946974, // UPä¸» mid
  order: UserVideoOrder.click, // æŒ‰æ’­æ”¾é‡æ’åº
  pn: 1,  // ç¬¬1é¡µ
  ps: 30, // æ¯é¡µ30ä¸ª
);

print('æ€»è§†é¢‘æ•°: ${videos.pageInfo.count}');
print('åˆ†åŒºç»Ÿè®¡:');
videos.categories.forEach((tid, category) {
  print('- ${category.name}: ${category.count} ä¸ªè§†é¢‘');
});

print('\nè§†é¢‘åˆ—è¡¨:');
for (var video in videos.videos) {
  print('---');
  print('æ ‡é¢˜: ${video.title}');
  print('BVå·: ${video.bvid}');
  print('æ’­æ”¾: ${video.play}');
  print('è¯„è®º: ${video.comment}');
  print('æ—¶é•¿: ${video.length}');
  print('å‘å¸ƒæ—¶é—´: ${DateTime.fromMillisecondsSinceEpoch(video.created * 1000)}');
}
```

#### æœç´¢ç”¨æˆ·è§†é¢‘

```dart
// æ–¹æ³•1: ä½¿ç”¨ä¸“é—¨çš„æœç´¢æ–¹æ³•
final results = await spaceApi.searchUserVideos(
  946974,
  'æ•™ç¨‹',  // æœç´¢å…³é”®è¯
  order: UserVideoOrder.pubdate, // æŒ‰æ—¶é—´æ’åº
);

// æ–¹æ³•2: ä½¿ç”¨é€šç”¨æ–¹æ³•
final results2 = await spaceApi.getUserVideos(
  946974,
  keyword: 'iPhone',
  order: UserVideoOrder.click,
);

print('æœç´¢åˆ° ${results.videos.length} ä¸ªè§†é¢‘');
```

#### æŒ‰åˆ†åŒºè·å–è§†é¢‘

```dart
// åªçœ‹ç§‘æŠ€åŒºçš„è§†é¢‘
final techVideos = await spaceApi.getUserVideosByCategory(
  946974,
  188, // ç§‘æŠ€åŒº tid
  order: UserVideoOrder.click,
);

print('ç§‘æŠ€åŒºè§†é¢‘: ${techVideos.videos.length} ä¸ª');
```

#### è‡ªåŠ¨è·å–æ‰€æœ‰è§†é¢‘

```dart
// è‡ªåŠ¨åˆ†é¡µè·å–æ‰€æœ‰æŠ•ç¨¿
final allVideos = await spaceApi.getAllUserVideos(
  946974,
  maxPages: 50, // æœ€å¤š50é¡µ
);

print('è¯¥UPå…±æŠ•ç¨¿ ${allVideos.length} ä¸ªè§†é¢‘');
```

---

## 3. è§†é¢‘æ¨¡å—

### 3.1 è·å–è§†é¢‘ä¿¡æ¯

```dart
final videoApi = VideoApi(client);

// é€šè¿‡ BV å·è·å–
final videoInfo = await videoApi.getVideoInfoByBvid('BV1xx411c7mD');

// æˆ–é€šè¿‡ AV å·è·å–
final videoInfo2 = await videoApi.getVideoInfoByAid(170001);

print('æ ‡é¢˜: ${videoInfo.title}');
print('UPä¸»: ${videoInfo.owner.name}');
print('ç®€ä»‹: ${videoInfo.desc}');
print('æ’­æ”¾: ${videoInfo.stat.view}');
print('å¼¹å¹•: ${videoInfo.stat.danmaku}');
print('ç‚¹èµ: ${videoInfo.stat.like}');
print('æŠ•å¸: ${videoInfo.stat.coin}');
print('æ”¶è—: ${videoInfo.stat.favorite}');
print('åˆ†äº«: ${videoInfo.stat.share}');

// åˆ†Pè§†é¢‘ä¿¡æ¯
if (videoInfo.videos > 1) {
  print('\nåˆ†Påˆ—è¡¨:');
  for (var page in videoInfo.pages) {
    print('P${page.page}: ${page.part} (${page.duration}ç§’)');
  }
}

// è¾…åŠ©æ–¹æ³•
print('\næ ¼å¼åŒ–æ’­æ”¾é‡: ${videoInfo.formatView()}');
print('æ ¼å¼åŒ–æ—¶é•¿: ${videoInfo.formatDuration()}');
```

### 3.2 è·å–è§†é¢‘æµ URL

è§†é¢‘æ’­æ”¾åœ°å€è·å–ï¼Œæ”¯æŒå¤šç§æ¸…æ™°åº¦å’Œæ ¼å¼ã€‚

```dart
final streamApi = VideoStreamApi(client);

// éœ€è¦ç™»å½•æ‰èƒ½è·å–é«˜æ¸…æ™°åº¦
// éœ€è¦å…ˆåˆ·æ–° WBI å¯†é’¥
await loginInfoApi.refreshWbiKeys();

// è·å–è§†é¢‘æµï¼ˆDASHæ ¼å¼æ¨èï¼‰
final stream = await streamApi.getDashStream(
  bvid: 'BV1xx411c7mD',
  cid: 123456,
);

print('è§†é¢‘è´¨é‡: ${stream.quality}');
print('æ ¼å¼: ${stream.format}');

// DASH æµä¿¡æ¯
if (stream.dash != null) {
  print('\nè§†é¢‘æµ:');
  for (var video in stream.dash!.video) {
    print('- æ¸…æ™°åº¦: ${video.id}, ç¼–ç : ${video.codecs}');
    print('  åœ°å€: ${video.baseUrl}');
  }
  
  print('\néŸ³é¢‘æµ:');
  for (var audio in stream.dash!.audio) {
    print('- éŸ³è´¨: ${audio.id}, ç¼–ç : ${audio.codecs}');
    print('  åœ°å€: ${audio.baseUrl}');
  }
}

// è·å– MP4 æ ¼å¼
final mp4Stream = await streamApi.getMp4Stream(
  bvid: 'BV1xx411c7mD',
  cid: 123456,
);

// æŒ‡å®šæ¸…æ™°åº¦
final hdStream = await streamApi.getVideoStream(
  bvid: 'BV1xx411c7mD',
  cid: 123456,
  quality: 80, // 1080P
);
```

### 3.3 è§†é¢‘æ“ä½œ

éœ€è¦ç™»å½•æ‰èƒ½è¿›è¡Œè¿™äº›æ“ä½œã€‚

#### ç‚¹èµè§†é¢‘

```dart
final actionApi = VideoActionApi(client);

// ç‚¹èµ
await actionApi.likeVideo(
  bvid: 'BV1xx411c7mD',
  like: true, // true=ç‚¹èµ, false=å–æ¶ˆç‚¹èµ
);

print('ç‚¹èµæˆåŠŸï¼');
```

#### æŠ•å¸

```dart
// æŠ•1ä¸ªå¸
await actionApi.coinVideo(
  bvid: 'BV1xx411c7mD',
  multiply: 1, // æŠ•å¸æ•°é‡ (1æˆ–2)
  alsoLike: true, // åŒæ—¶ç‚¹èµ
);

print('æŠ•å¸æˆåŠŸï¼');
```

#### æ”¶è—è§†é¢‘

```dart
// æ·»åŠ åˆ°å¤šä¸ªæ”¶è—å¤¹
await actionApi.favoriteVideo(
  bvid: 'BV1xx411c7mD',
  addMediaIds: [123, 456], // æ·»åŠ åˆ°çš„æ”¶è—å¤¹ID
  delMediaIds: [789],      // ä»è¿™äº›æ”¶è—å¤¹ç§»é™¤
);

print('æ”¶è—æˆåŠŸï¼');
```

#### ä¸€é”®ä¸‰è¿

```dart
// åŒæ—¶ç‚¹èµã€æŠ•å¸ã€æ”¶è—
await actionApi.tripleAction(bvid: 'BV1xx411c7mD');

print('ä¸‰è¿æˆåŠŸï¼');
```

---

## 4. æœç´¢æ¨¡å—

### 4.1 ç»¼åˆæœç´¢

æœç´¢æ‰€æœ‰ç±»å‹çš„å†…å®¹ï¼ˆè§†é¢‘ã€ç”¨æˆ·ã€æ–‡ç« ç­‰æ··åˆç»“æœï¼‰ã€‚

```dart
final searchApi = SearchApi(client);

// éœ€è¦å…ˆåˆ·æ–° WBI å¯†é’¥
await loginInfoApi.refreshWbiKeys();

// ç»¼åˆæœç´¢
final results = await searchApi.searchAll(
  'flutteræ•™ç¨‹',
  page: 1,
);

print('æœç´¢ç»“æœæ€»æ•°: ${results['numResults']}');

// ç»“æœæ˜¯åŸå§‹ JSON Mapï¼Œéœ€è¦è‡ªå·±è§£æ
```

### 4.2 è§†é¢‘æœç´¢

ä¸“é—¨æœç´¢è§†é¢‘ï¼Œæ”¯æŒå¤šç§ç­›é€‰ã€‚

```dart
final videoResults = await searchApi.searchVideos(
  'flutter',
  page: 1,
  order: SearchOrder.totalRank, // ç»¼åˆæ’åº
  duration: 2, // æ—¶é•¿ç­›é€‰: 1=<10åˆ†é’Ÿ, 2=10-30åˆ†é’Ÿ, 3=30-60åˆ†é’Ÿ, 4=>60åˆ†é’Ÿ
  category: 36, // åˆ†åŒºç­›é€‰
);

// è§£æè§†é¢‘ç»“æœ
final videos = (videoResults['result'] as List)
    .map((v) => VideoSearchResult.fromJson(v))
    .toList();

for (var video in videos) {
  print('---');
  print('æ ‡é¢˜: ${video.title}');
  print('UPä¸»: ${video.author}');
  print('æ’­æ”¾: ${video.play}');
  print('BVå·: ${video.bvid}');
}
```

#### æœç´¢æ’åºæ–¹å¼

```dart
// ç»¼åˆæ’åºï¼ˆé»˜è®¤ï¼‰
SearchOrder.totalRank

// æœ€å¤šæ’­æ”¾
SearchOrder.click

// æœ€æ–°å‘å¸ƒ
SearchOrder.pubdate

// æœ€å¤šå¼¹å¹•
SearchOrder.dm

// æœ€å¤šæ”¶è—
SearchOrder.stow
```

### 4.3 ç”¨æˆ·æœç´¢

æœç´¢ UPä¸»å’Œç”¨æˆ·ã€‚

```dart
final userResults = await searchApi.searchUsers(
  'å½±è§†é£“é£',
  page: 1,
  order: SearchOrder.fans,  // æŒ‰ç²‰ä¸æ•°æ’åº
);

final users = (userResults['result'] as List)
    .map((u) => UserSearchResult.fromJson(u))
    .toList();

for (var user in users) {
  print('---');
  print('ç”¨æˆ·å: ${user.uname}');
  print('UID: ${user.mid}');
  print('ç²‰ä¸: ${user.fans}');
  print('è§†é¢‘: ${user.videos}');
}
```

### 4.4 æœç´¢å»ºè®®

è·å–æœç´¢å…³é”®è¯å»ºè®®ï¼ˆè‡ªåŠ¨è¡¥å…¨ï¼‰ã€‚

```dart
// è·å–æœç´¢å»ºè®®
final suggestions = await searchApi.getSuggestions('flutter');

for (var suggestion in suggestions) {
  print('å»ºè®®: ${suggestion.value}');
  print('çº¯æ–‡æœ¬: ${suggestion.plainText}'); // å»é™¤HTMLæ ‡ç­¾
}
```

---

## 5. åŠ¨æ€æ¨¡å—

åŠ¨æ€æ¨¡å—é‡‡ç”¨ç®€åŒ–å®ç°ï¼Œè¿”å›åŸå§‹ JSON æ•°æ®ï¼Œç”¨æˆ·å¯æ ¹æ®éœ€è¦è‡ªè¡Œè§£æã€‚

### 5.1 è·å–åŠ¨æ€åˆ—è¡¨

è·å–å…³æ³¨çš„äººçš„åŠ¨æ€ã€‚

```dart
final dynamicApi = DynamicApi(client);

// éœ€è¦ç™»å½•
// è·å–å…¨éƒ¨åŠ¨æ€
final dynamics = await dynamicApi.getAllDynamics(
  type: 'all', // all=å…¨éƒ¨, video=è§†é¢‘, pgc=ç•ªå‰§, article=ä¸“æ 
);

print('æ˜¯å¦æœ‰æ›´å¤š: ${dynamics['has_more']}');
print('ä¸‹ä¸€é¡µoffset: ${dynamics['offset']}');

// è§£æåŠ¨æ€åˆ—è¡¨
final items = dynamics['items'] as List;
for (var item in items) {
  print('åŠ¨æ€ID: ${item['id_str']}');
  print('ç±»å‹: ${item['type']}');
  
  // ä½¿ç”¨è¾…åŠ©æ–¹æ³•æå–åŸºæœ¬ä¿¡æ¯
  final basicInfo = DynamicApi.extractBasicInfo(item);
  if (basicInfo != null) {
    print('ä½œè€…: ${basicInfo['author_name']}');
    print('å‘å¸ƒæ—¶é—´: ${basicInfo['pub_time']}');
    print('ç‚¹èµ: ${basicInfo['like_count']}');
  }
}

// è·å–ä¸‹ä¸€é¡µ
final nextPage = await dynamicApi.getAllDynamics(
  offset: dynamics['offset'],
);
```

### 5.2 è·å–ç”¨æˆ·ç©ºé—´åŠ¨æ€

```dart
// è·å–æŸç”¨æˆ·çš„åŠ¨æ€
final userDynamics = await dynamicApi.getUserSpaceDynamics(
  293793435, // ç”¨æˆ· mid
  useWbiSign: true, // æœªç™»å½•æ—¶ä½¿ç”¨ WBI ç­¾å
);

final items = userDynamics['items'] as List;
print('è¯¥ç”¨æˆ·å‘äº† ${items.length} æ¡åŠ¨æ€');
```

### 5.3 è·å–åŠ¨æ€è¯¦æƒ…

```dart
// è·å–ç‰¹å®šåŠ¨æ€çš„è¯¦æƒ…
final detail = await dynamicApi.getDynamicDetail('507420325550127049');

final card = detail['card'];
print('åŠ¨æ€è¯¦æƒ…: $card');
```

---

## é«˜çº§ç”¨æ³•

### 1. Cookie æŒä¹…åŒ–

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥æŒä¹…åŒ–ä¿å­˜ Cookieã€‚

```dart
import 'package:shared_preferences/shared_preferences.dart';

// ä¿å­˜ Cookie
Future<void> saveCookies(CookieManager cookieManager) async {
  final prefs = await SharedPreferences.getInstance();
  final cookies = cookieManager.getAllCookies();
  
  await prefs.setString('sessdata', cookies['SESSDATA'] ?? '');
  await prefs.setString('bili_jct', cookies['bili_jct'] ?? '');
  await prefs.setString('buvid3', cookies['buvid3'] ?? '');
}

// åŠ è½½ Cookie
Future<CookieManager> loadCookies() async {
  final prefs = await SharedPreferences.getInstance();
  final cookieManager = CookieManager();
  
  final sessdata = prefs.getString('sessdata');
  final biliJct = prefs.getString('bili_jct');
  final buvid3 = prefs.getString('buvid3');
  
  if (sessdata != null) cookieManager.setCookie('SESSDATA', sessdata);
  if (biliJct != null) cookieManager.setCookie('bili_jct', biliJct);
  if (buvid3 != null) cookieManager.setCookie('buvid3', buvid3);
  
  return cookieManager;
}
```

### 2. é”™è¯¯å¤„ç†

æ‰€æœ‰ API è°ƒç”¨éƒ½å¯èƒ½æŠ›å‡º `BiliException`ã€‚

```dart
try {
  final userInfo = await userApi.getUserInfo(12345);
  print('ç”¨æˆ·å: ${userInfo.name}');
} on BiliException catch (e) {
  print('é”™è¯¯ç : ${e.code}');
  print('é”™è¯¯ä¿¡æ¯: ${e.message}');
  
  // å¸¸è§é”™è¯¯ç 
  if (e.code == -101) {
    print('æœªç™»å½•');
  } else if (e.code == -404) {
    print('ç”¨æˆ·ä¸å­˜åœ¨');
  }
} catch (e) {
  print('å…¶ä»–é”™è¯¯: $e');
}
```

### 3. è‡ªå®šä¹‰è¯·æ±‚å¤´

å¦‚æœéœ€è¦è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆå¦‚User-Agentï¼‰ï¼Œå¯ä»¥ä¿®æ”¹ `BiliHttpClient`ã€‚

```dart
// åœ¨ http_client.dart ä¸­çš„ _getHeaders() æ–¹æ³•æ·»åŠ 
// æˆ–è€…ç»§æ‰¿ BiliHttpClient è‡ªå®šä¹‰
```

### 4. WBI ç­¾åè°ƒè¯•

æŸ¥çœ‹ WBI ç­¾åæ˜¯å¦æ­£ç¡®ã€‚

```dart
final loginInfoApi = LoginInfoApi(client);
await loginInfoApi.refreshWbiKeys();

// å¯†é’¥ä¼šè‡ªåŠ¨ä¿å­˜åˆ° CookieManager
print('WBIæ­£åœ¨ä½¿ç”¨çš„å¯†é’¥:');
print('IMG Key: ${cookieManager.getCookie('wbi_img_key')}');
print('SUB Key: ${cookieManager.getCookie('wbi_sub_key')}');
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæœ‰äº› API è°ƒç”¨å¤±è´¥ï¼Ÿ

**A:** å¤§å¤šæ•°æƒ…å†µæ˜¯å› ä¸ºï¼š
1. æœªç™»å½•ï¼ˆéœ€è¦ SESSDATA cookieï¼‰
2. æœªåˆ·æ–° WBI å¯†é’¥ï¼ˆæŸäº› API éœ€è¦ï¼‰
3. Cookie å·²è¿‡æœŸ

è§£å†³æ–¹æ³•ï¼š
```dart
// ç¡®ä¿å·²ç™»å½•
// ç¡®ä¿åˆ·æ–°äº† WBI å¯†é’¥
await loginInfoApi.refreshWbiKeys();
```

### Q2: Cookie å¤šä¹…ä¼šè¿‡æœŸï¼Ÿ

**A:** SESSDATA çš„æœ‰æ•ˆæœŸé€šå¸¸ä¸ºå‡ ä¸ªæœˆã€‚åœ¨å¤±æ•ˆå‰ä¼šä¸€ç›´æœ‰æ•ˆï¼Œæ— éœ€åˆ·æ–°ã€‚å¦‚æœå¤±æ•ˆï¼Œé‡æ–°æ‰«ç ç™»å½•å³å¯ã€‚

### Q3: å¦‚ä½•è·å–é«˜æ¸…è§†é¢‘æµï¼Ÿ

**A:** éœ€è¦ï¼š
1. ç™»å½•è´¦å·
2. è´¦å·æœ‰å¤§ä¼šå‘˜æƒé™ï¼ˆ4Kéœ€è¦ï¼‰
3. ä½¿ç”¨æ­£ç¡®çš„ `fnval` å’Œ `fourk` å‚æ•°

```dart
final stream = await streamApi.getVideoStream(
  bvid: 'BV1xx411c7mD',
  cid: 123456,
  quality: 120, // 4K
  fourk: true,  // å…è®¸4K
);
```

### Q4: æœç´¢ç»“æœä¸ºä»€ä¹ˆæ˜¯ Map è€Œä¸æ˜¯å¼ºç±»å‹ï¼Ÿ

**A:** å› ä¸ºæœç´¢ç»“æœç±»å‹éå¸¸å¤šæ ·ï¼ˆè§†é¢‘ã€ç”¨æˆ·ã€æ–‡ç« ã€ç•ªå‰§ç­‰ï¼‰ï¼Œä¸ºäº†çµæ´»æ€§è¿”å› Mapã€‚ä½ å¯ä»¥æ ¹æ® `result_type` å­—æ®µåˆ¤æ–­ç±»å‹åè§£æã€‚

### Q5: åŠ¨æ€æ¨¡å—ä¸ºä»€ä¹ˆè¿”å›åŸå§‹ JSONï¼Ÿ

**A:** åŠ¨æ€çš„æ•°æ®ç»“æ„æå…¶å¤æ‚ï¼ˆ10+ç§ç±»å‹ï¼ŒåµŒå¥—6-8å±‚ï¼‰ï¼Œå®Œæ•´å®ç°éœ€è¦20+ä¸ªæ¨¡å‹ç±»å’Œ500+è¡Œä»£ç ã€‚ç®€åŒ–å®ç°æ›´çµæ´»ï¼Œç”¨æˆ·å¯æŒ‰éœ€è§£æã€‚

### Q6: buvid3 æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•è·å–ï¼Ÿ

**A:** buvid3 æ˜¯ Bç«™ çš„è®¾å¤‡æŒ‡çº¹ã€‚å¯ä»¥é€šè¿‡æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹ï¼Œæˆ–ä½¿ç”¨éšæœºå­—ç¬¦ä¸²ã€‚

### Q7: å¦‚ä½•å¤„ç†é£æ§ï¼Ÿ

**A:** Bç«™ æœ‰åçˆ¬è™«æœºåˆ¶ï¼š
- ä½¿ç”¨ WBI ç­¾åï¼ˆå·²è‡ªåŠ¨å¤„ç†ï¼‰
- æ§åˆ¶è¯·æ±‚é¢‘ç‡  
- ä½¿ç”¨çœŸå®çš„ User-Agent
- å¿…è¦æ—¶æ·»åŠ  buvid3

### Q8: å¦‚ä½•ä¸‹è½½è§†é¢‘ï¼Ÿ

**A:** 
1. ä½¿ç”¨ `VideoStreamApi` è·å–è§†é¢‘æµ URL
2. å¯¹äº DASH æ ¼å¼ï¼Œéœ€è¦åˆ†åˆ«ä¸‹è½½è§†é¢‘æµå’ŒéŸ³é¢‘æµ
3. ä½¿ç”¨ ffmpeg åˆå¹¶

```dart
final stream = await streamApi.getDashStream(bvid: 'BV...', cid: 123);
final videoUrl = stream.dash!.video.first.baseUrl;
final audioUrl = stream.dash!.audio.first.baseUrl;

// ä½¿ç”¨ http åŒ…ä¸‹è½½
// ä½¿ç”¨ ffmpeg åˆå¹¶
```

---

## ç¤ºä¾‹é¡¹ç›®

æŸ¥çœ‹ `example/` ç›®å½•è·å–å®Œæ•´ç¤ºä¾‹ï¼š

- [qr_login_example.dart](example/qr_login_example.dart) - äºŒç»´ç ç™»å½•æµç¨‹
- [user_info_example.dart](example/user_info_example.dart) - ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
- [video_info_example.dart](example/video_info_example.dart) - è§†é¢‘ä¿¡æ¯æŸ¥è¯¢
- [video_stream_example.dart](example/video_stream_example.dart) - è§†é¢‘æµè·å–å’Œæ“ä½œ
- [search_example.dart](example/search_example.dart) - æœç´¢åŠŸèƒ½

---

## API å‚è€ƒ

å®Œæ•´ API æ–‡æ¡£è¯·æŸ¥çœ‹æºä»£ç æ³¨é‡Šæˆ–è®¿é—® [pub.dev](https://pub.dev/packages/bilibili_api)ã€‚

---

## è®¸å¯è¯

MIT License

---

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

## è‡´è°¢

æ„Ÿè°¢ [SocialSisterYi/bilibili-API-collect](https://github.com/SocialSisterYi/bilibili-API-collect) é¡¹ç›®æä¾›çš„ API æ–‡æ¡£ã€‚
